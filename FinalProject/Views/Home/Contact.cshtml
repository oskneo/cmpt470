@using Microsoft.AspNetCore.Identity
@using FinalProject.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Contact";
}
<h2>@ViewData["Title"]</h2>
<h3>@ViewData["Message"]</h3>



<div id="messageinput">
<br>
<h2>Live Help</h2>
@if (SignInManager.IsSignedIn(User))
{
    <div id="nameinput" hidden>Username: <input type="text" id="username" value="@UserManager.GetUserName(User)"/></div>
}
else
{
    <div id="nameinput">Username: <input type="text" id="username" value=""/></div>

}
Message: <input type="text" id="message" /> 
</div id="">
<input type="button" id="send" value="Send" />
<div id="instantmessage">
<ul id="liveHelp"></ul>
</div>

<div id="MessageBox"></div>
@section scripts {
    <script src="~/js/signalr-client-1.0.0-alpha2-final.js"></script>
    <script>
    
        
    let transportType = signalR.TransportType.WebSockets;
    let http = new signalR.HttpConnection(`http://${document.location.host}/lhh/livehelphub`, { transport: transportType });
    let connection = new signalR.HubConnection(http);
    connection.start();
 
    connection.on('Send', (name, message) => {
        if (name==""){
            name="Anonymous";
        }
        appendLine(message, name);    
    });
 
    document.getElementById('send').addEventListener('click', event => {
        let message = document.getElementById('message').value;
        let name = document.getElementById('username').value;
        document.getElementById('message').value = '';
        
 
        connection.invoke('Send', name, message);   
        event.preventDefault();
    });
    
    $("#message").keyup(function(event) {
        if (event.keyCode === 13) {
            $("#send").click();
        }
    });
    $("#username").keyup(function(event) {
        if (event.keyCode === 13) {
            $("#send").click();
        }
    });
 
    function appendLine(line, name) {
        let li = document.createElement('li');
        li.innerText = name + ":" + line;
        document.getElementById('liveHelp').appendChild(li);
        document.getElementById('layoutmessage').innerText="Message from " + name + ":" + line;
    };
    </script>
}
@section Styles {
    <link href="@Url.Content("~/css/contact.css")" rel="stylesheet" type="text/css" />
}